<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Stock Alert Light</title>
    <style>
      body { font-family: Arial, sans-serif; text-align:center; padding:30px }
      .stock-box {
        border: 2px solid #ddd;
        padding: 20px;
        margin: 20px auto;
        width: 350px;
        border-radius: 12px;
        box-shadow: 0 0 10px #ccc;
      }
      .dot {
        height: 70px;
        width: 70px;
        border-radius: 50%;
        margin: 10px auto;
        box-shadow: 0 0 20px gray;
        transition: background-color 0.3s, box-shadow 0.3s;
      }
      table {
        width: 100%;
        margin-top: 10px;
        border-collapse: collapse;
      }
      table td {
        padding: 6px;
        border-bottom: 1px solid #ddd;
        text-align: left;
      }
      .breakout {
        font-size: 14px;
        margin-top: 10px;
        color: #d9534f;
      }
    </style>
  </head>

  <body>
    <h1>Stock Alert Monitor</h1>
    <div id="lights"></div>
    <div class="label" id="info">Loading...</div>

    <script>
      const backend = (window.BACKEND_URL || "https://your-backend.onrender.com").replace(/\/$/, '');

      async function fetchStatus() {
        try {
          const res = await fetch(`${backend}/status`);
          const data = await res.json();
          const container = document.getElementById('lights');
          container.innerHTML = '';

          for (const [name, v] of Object.entries(data.stocks)) {
            const box = document.createElement('div');
            box.className = "stock-box";

            // LIGHT INDICATOR
            const dot = document.createElement('div');
            dot.className = "dot";

            if (v.status === 'AMBER') {
              dot.style.backgroundColor = "orange";
              dot.style.boxShadow = "0 0 25px orange";
            } else if (v.status === 'RED') {
              dot.style.backgroundColor = "red";
              dot.style.boxShadow = "0 0 25px red";
            } else {
              dot.style.backgroundColor = "gray";
              dot.style.boxShadow = "0 0 25px gray";
            }

            // TITLE
            const title = document.createElement('h2');
            title.innerText = name;

            // PRICE TABLE
            const tbl = document.createElement('table');
            tbl.innerHTML = `
              <tr><td><strong>High:</strong></td><td>${v.high ?? 'N/A'}</td></tr>
              <tr><td><strong>Low:</strong></td><td>${v.low ?? 'N/A'}</td></tr>
              <tr><td><strong>Last Price:</strong></td><td>${v.last_price ?? 'N/A'}</td></tr>
            `;

            // BREAKOUT INFO WHEN STATUS == AMBER
            let breakout = null;
            if (v.status === "AMBER") {
              breakout = document.createElement('div');
              breakout.className = "breakout";
              breakout.innerHTML = `
                ðŸ”” <strong>Breakout</strong><br>
                Time: ${v.trigger_time || "N/A"}<br>
                Breakout Price: ${v.trigger_price || "N/A"}
              `;
            }

            // append all
            box.appendChild(title);
            box.appendChild(dot);
            box.appendChild(tbl);
            if (breakout) box.appendChild(breakout);

            container.appendChild(box);
          }

          document.getElementById('info').innerText = 'Last updated: ' + data.time;

        } catch (e) {
          console.error(e);
          document.getElementById('info').innerText = 'Error fetching status';
        }
      }

      fetchStatus();
      setInterval(fetchStatus, 3000);
    </script>
  </body>
</html>